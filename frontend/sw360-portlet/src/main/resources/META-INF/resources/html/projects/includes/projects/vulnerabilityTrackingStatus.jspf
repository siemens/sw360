<%--
  ~ SPDX-FileCopyrightText: Â© 2022 Siemens AG
  ~ SPDX-License-Identifier: EPL-2.0
--%>
<%@ page import="org.eclipse.sw360.datahandler.common.SW360Constants" %>

<c:set var="svmComponentId" value="<%=SW360Constants.SVM_COMPONENT_ID%>"/>
<c:set var="svmShortStatus" value="<%=SW360Constants.SVM_SHORT_STATUS%>"/>
<c:set var="svmMonitoringListId" value="<%=SW360Constants.SVM_MONITORINGLIST_ID%>"/>
<div class="container">
    <div class="row mt-2">
        <div class="col">
            <h4><liferay-ui:message key="vulnerability.state.information" /></h4>
        </div>
    </div>
    <div class="row stateinfo mb-1">
        <div class="col-4">
            <liferay-ui:message key="security.vulnerability.monitoring" />:
        </div>
        <div class="col">
            <core_rt:if test="${project.enableSvm}">
                <span class="badge badge-success"><liferay-ui:message key="enabled" /></span>
            </core_rt:if>
            <core_rt:if test="${not project.enableSvm}">
                <span class="badge badge-secondary"><liferay-ui:message key="disabled" /></span>
            </core_rt:if>
        </div>
    </div>
    <div class="row stateinfo mb-1">
        <div class="col-4">
            <liferay-ui:message key="do.not.create.monitoring.list.but.use.list.from.external.id" />:
        </div>
        <div class="col">
            <core_rt:if test="${project.considerReleasesFromExternalList}">
                <span class="badge badge-success"><liferay-ui:message key="enabled" /></span>
            </core_rt:if>
            <core_rt:if test="${not project.considerReleasesFromExternalList}">
                <span class="badge badge-secondary"><liferay-ui:message key="disabled" /></span>
            </core_rt:if>
        </div>
    </div>
        <div class="row stateinfo mb-1">
        <div class="col-4">
            ${svmMonitoringListId}:
        </div>
        <div class="col">
            <sw360:DisplayExternalId value="${project.externalIds['${svmMonitoringListId}']}"/>
        </div>
    </div>
    <core_rt:if test="${releasesAndProjects.size() == 0 }">
        <div class="alert alert-info" role="alert">
            Please add linked releases or projects with linked releases to view their vulnerabilities tracking status here.
        </div>
    </core_rt:if>

    <core_rt:if test="${releasesAndProjects.size()  > 0 }">
        <div id="vulnerabilityTrackingTableDiv">
            <table id="vulnerabilityTrackingTable" class="table table-bordered"></table>
        </div>
    </core_rt:if>
</div>
<script type="text/javascript">

    require(['jquery', 'bridges/datatables'], function ($, datatables) {
        var vulnerabilityTrackingTable;
        createVulnerabilityTrackingTable();

        function renderVulnerabilityTrackingStatus(svmId) {
            // test that the svmId is a string and contains an integer (ignoring leading and trailing whitespace)
            if (typeof svmId === "string" && new RegExp("^\\d+$").test(svmId.trim())){
                return "<span class='notificationBulletInline backgroundOK' title='SVM id: " + svmId + "'>tracked</span>";
            } else {
                return "<span class='notificationBulletInline backgroundGrey'>not tracked</span>";
            }
        }
        function createVulnerabilityTrackingTable() {
            var result = [];

            <core_rt:forEach items="${releasesAndProjects}" var="releasesClearingStatusData">
            result.push({
                "0": "<sw360:DisplayReleaseLink release="${releasesClearingStatusData.release}" showFullname="true"/>",
                "1": "<sw360:out value="${releasesClearingStatusData.projectNames}"/>",
                <core_rt:if test="${not empty releasesClearingStatusData.release.externalIds}">
                    "2": "${releasesClearingStatusData.release.externalIds[svmComponentId]}",
                </core_rt:if>
                <core_rt:if test="${empty releasesClearingStatusData.release.externalIds}">
                    "2": "",
                </core_rt:if>
                <core_rt:if test="${not empty releasesClearingStatusData.release.additionalData}">
                    "3": "${releasesClearingStatusData.release.additionalData[svmShortStatus]}",
                </core_rt:if>
                <core_rt:if test="${empty releasesClearingStatusData.release.additionalData}">
                    "3": "",
                </core_rt:if>
                "4": "<sw360:DisplayEnum value="${releasesClearingStatusData.componentType}"/>"
            });
            </core_rt:forEach>

            datatables.create('#vulnerabilityTrackingTable', {
                data: result,
                columns: [
                    {title: "<liferay-ui:message key="name" />", width:"20%"},
                    {title: "<liferay-ui:message key="project.origin" />", width:"20%"},
                    {title: "<liferay-ui:message key="svm.tracking.status" />", render: renderVulnerabilityTrackingStatus, width:"15%"},
                    {title: "<liferay-ui:message key="short.status" />", width:"30"},
                    {title: "<liferay-ui:message key="type" />", width:"15%"}
                ],
                "order": [[ 0, "asc" ]],
                fnDrawCallback: datatables.showPageContainer,
                language: {
                    url: "<liferay-ui:message key="datatables.lang" />",
                    loadingRecords: "<liferay-ui:message key="loading" />"
                }
            }, [0, 1, 2, 3, 4], undefined, true);
        }
    });
</script>
